<!DOCTYPE html>
<html lang="en">

<head>
    <%- include ('../partials/partial') %>
        <title>Select Basket</title>

        <style>
            body {
                background-color: whitesmoke;
            }

            #basketDiv {
                margin-top: 30px;
                background-color: white;
                padding: 30px;
                border-radius: 20px;
                width: 1450px;
            }

            #subjectColumn {
                margin-left: 430px;
            }

            #basketSubject {
                margin-left: 20px;
            }

            #note {
                margin-bottom: 50px;
            }
        </style>

</head>

<body>
    <%- include('sidebar.ejs') %>
        <%- include('header.ejs') %>
            <div id="mains">
                <%- include('messageModal.ejs') %>
                <h4 id="eventName" class="mt-4 ml-4" data-eventLid="<%= showBasket[0].id %>">
                    <%= showBasket[0].event_name %>
                </h4>

                <div id="basketDiv">
                    <h5 id="basketName" data-basketLid="<%= showBasket[0].basket_lid %>">
                        <%= showBasket[0].basket_name %>
                    </h5>
                    </br>
                    <h5>
                        Preference Order
                    </h5>
                    <p id="note" style="color:red;">*Please Check The Order Of Preferences Here As Selected From 1 To 5,
                        Deselect and Reselect
                        Subject To Change Order If Needed </p>
                    <div>
                        <% let index=1; %>
                        <input id="basketData" type="text" data-userLid="<%= module[0].id %>" data-compSub = "<%= showBasket[0].no_of_comp_sub %>" hidden />
                            <% for(let i=1;i<=5;i++) {%>
                                <div style="display: flex;align-items:center;"><span class="mr-2">
                                    Preference No.<%= index %>.
                                    </span><select class="selectSubject form-control">
                                        <option id ="defaultCourse" selected>Select Course</option>
                                        <% showBasket.forEach(datas=> { %>
                                            <option class="subjectName" value="<%= datas.sub_id %>" >
                                                <%= datas.subject_name %>
                                            </option>
                                            <% }) %>
                                                <% yearBackSubjects.forEach(data=> { %>
                                                    <option style="color:grey;" disabled>
                                                        <%= data.subject_name %>
                                                    </option>
                                                    <% }); %>
                                    </select></div></br>

                                <% index++; %>
                                    <% } %>
                    </div>
                    <div>
                    </div>
                    <button class="btn btn-primary ml-3 mt-4 reset">Reset</button><button
                        class="btn btn-danger ml-3 mt-4 insertNext">Next</button>
                </div>
            </div>
</body>

<%- include ('../partials/partial2') %>
<script src= "../js/script.js" ></script>
<script>

 document.addEventListener('click',function(e){

 if(e.target.classList.contains('reset')){
  let selectValue = document.querySelectorAll('.selectSubject');
  let defaultCourse =document.querySelector('#defaultCourse');

}
  
 if(e.target.classList.contains('insertNext')){
    const currentTime = new Date();
     const timeString = currentTime.toLocaleString('en-US', {hour12:false});

     console.log("timestring ",timeString);

     let compSub = document.querySelector('#basketData').getAttribute('data-compSub');
     let eventLid =  document.querySelector('#eventName').getAttribute('data-eventLid');
     let userLid =  document.querySelector('#basketData').getAttribute('data-userLid');
     let basketLid = document.querySelector('#basketName').getAttribute('data-basketLid')

     console.log(compSub,eventLid,userLid,basketLid);
     let courseArray = [];

     let selectSubject = document.querySelectorAll('.selectSubject');
     let counter = 1;
     Array.from(selectSubject).forEach(data => {

         let defaultCourse = data.querySelector('#defaultCourse');
         let subjectName = data.options[data.selectedIndex].textContent.trim();

         if (subjectName != data.value) {
             courseArray.push({ subjectLid: data.value, preference: counter });
             counter++;
         }

     })

     console.log('comp sub and array ', compSub, JSON.stringify(courseArray));

     if (courseArray.length >= compSub) {
         let obj = { eventLid, timeString, courseArray, userLid,basketLid };
         console.log(obj)

         dynamicFetchApi('/elective/insertStudentCourses','POST',obj)
         .then(response => {
          console.log(response);
         })

     } else {
         let modalBody = document.querySelector('#msgModal');
         modalBody.innerHTML = `<h4 style="text-align:center;">Select Courses ${compSub} or more than ${compSub} !!</h4>`;
         document.querySelector('[data-target="#messageModal"]').click();
     }
    
 }




 })

</script>
</html>